<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>אלפון ניווט V3.4.1</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; direction: rtl; }
        #debug { background: #333; color: #fff; padding: 10px; font-size: 12px; height: 80px; overflow-y: auto; }
        #map { height: calc(100vh - 150px); width: 100%; background: #ddd; }
        .controls { padding: 10px; background: #eee; }
    </style>
</head>
<body>

<div id="debug">מתחיל הרצה...</div>

<div class="controls">
    <input type="text" id="sSearch" placeholder="חיפוש..." oninput="filter()">
</div>

<div id="map"></div>

<script>
    const log = (m) => { document.getElementById('debug').innerHTML += "<br>> " + m; };
    
    // כתובת ה-CSV שלך
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRQFmvRO2y4PoaVgEnhCOxf3G92L_0wO73LPbsCvn33n1zSvClsw0fjsVv090wBz0CKcho45E8HKPXX/pub?gid=1872889823&single=true&output=csv";

    let data = [];
    let map, markers;

    async function start() {
        log("מאתחל מפה...");
        try {
            map = L.map('map').setView([32.11, 35.26], 11);
            L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}').addTo(map);
            markers = L.layerGroup().addTo(map);
            log("מפה הוגדרה.");
        } catch(e) { log("שגיאת מפה: " + e.message); }

        log("מושך נתונים מגוגל...");
        try {
            const res = await fetch(csvUrl + "&cache=" + Date.now());
            const text = await res.text();
            log("התקבל קובץ. גודל: " + text.length);

            const lines = text.split(/\r?\n/).slice(1);
            data = lines.map(line => {
                const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return {
                    name: (c[1] || "").replace(/"/g, ''),
                    lat: parseFloat(c[2]),
                    lon: parseFloat(c[3])
                };
            }).filter(i => i.name && !isNaN(i.lat));

            log("נמצאו " + data.length + " נקודות תקינות.");
            filter();
        } catch(e) { log("שגיאת טעינה: " + e.message); }
    }

    function filter() {
        const s = document.getElementById('sSearch').value.toLowerCase();
        markers.clearLayers();
        const filtered = data.filter(i => i.name.toLowerCase().includes(s));
        
        filtered.forEach(i => {
            L.marker([i.lat, i.lon]).addTo(markers).bindPopup(i.name);
        });
        
        if (filtered.length > 0) {
            const pts = filtered.map(i => [i.lat, i.lon]);
            map.fitBounds(pts, {padding: [30,30]});
        }
    }

    start();
</script>
</body>
</html>
