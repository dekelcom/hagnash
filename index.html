<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>驻  - V3.3.2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; margin: 0; padding: 0; direction: rtl; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: #f4f7f6; }
        .header { background: #2c3e50; color: white; padding: 10px; text-align: center; flex-shrink: 0; }
        .controls { background: white; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000; flex-shrink: 0; }
        .filters { display: flex; gap: 8px; margin-bottom: 10px; }
        select, input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; background: white; box-sizing: border-box; }
        #map { flex-grow: 1; width: 100%; background: #eee; }
        .locate-btn { position: absolute; bottom: 30px; right: 20px; z-index: 1000; background: white; border: none; width: 60px; height: 60px; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; font-size: 30px; display: flex; align-items: center; justify-content: center; }
        .status-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 10px; z-index: 2000; display: none; text-align: center; }
    </style>
</head>
<body>

<div id="status" class="status-msg">注 转...</div>

<div class="header">
    <h3 style="margin:0;">驻  专转</h3>
    <small>专住 3.3.2 (Safe Mode)</small>
</div>

<div class="controls">
    <div class="filters">
        <select id="pFilter" onchange="resetSearch(); filter();"><option value=""> 驻转</option></select>
        <select id="tFilter" onchange="resetSearch(); filter();"><option value=""> 住</option></select>
    </div>
    <input type="text" id="sSearch" placeholder="驻砖 砖 注..." oninput="filter()" list="destinationsList" autocomplete="off">
    <datalist id="destinationsList"></datalist>
</div>

<div id="map"></div>
<button class="locate-btn" onclick="locateUser()"></button>

<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRQFmvRO2y4PoaVgEnhCOxf3G92L_0wO73LPbsCvn33n1zSvClsw0fjsVv090wBz0CKcho45E8HKPXX/pub?gid=1872889823&single=true&output=csv'; 
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbz59ojIxoa_o5MTDtpwKYRCRxkU9R5oridtfu6_815PDJDV0tY-sjrANfnlehKRQCzj/exec'; 

    let data = [];
    let map, markersGroup, userMarker;

    function initMap() {
        const sat = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { attribution: 'Google' });
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' });
        map = L.map('map', { center: [32.11, 35.26], zoom: 11, layers: [sat] });
        L.control.layers({ "转爪\"": sat, "驻": osm }, null, { collapsed: true }).addTo(map);
        markersGroup = L.layerGroup().addTo(map);
    }

    async function loadData() {
        const status = document.getElementById('status');
        status.style.display = 'block';
        try {
            const res = await fetch(csvUrl + "&cb=" + Date.now());
            if (!res.ok) throw new Error("Connection failed");
            const text = await res.text();
            const lines = text.split(/\r?\n/).slice(1);
            
            data = lines.map((line, index) => {
                try {
                    const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if (c.length < 4) return null;
                    const lat = parseFloat(c[2]);
                    const lon = parseFloat(c[3]);
                    if (isNaN(lat) || isNaN(lon)) return null;
                    return {
                        id: index + 2,
                        type: (c[0] || "").replace(/"/g, '').trim(),
                        name: (c[1] || " 砖").replace(/"/g, '').trim(),
                        lat: lat,
                        lon: lon,
                        pluga: (c[5] || "").replace(/"/g, '').trim()
                    };
                } catch(e) { return null; }
            }).filter(i => i !== null);

            if (data.length === 0) {
                status.innerHTML = "拽抓 注   专拽   转拽";
            } else {
                status.style.display = 'none';
                fillFilters();
                filter();
            }
        } catch (e) {
            status.innerHTML = "砖 注:  砖砖 专  驻专住";
            console.error(e);
        }
    }

    function locateUser() { map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true}); }
    map.on('locationfound', (e) => {
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.circleMarker(e.latlng, { radius: 10, color: '#fff', fillColor: '#2ecc71', fillOpacity: 1, weight: 3 }).addTo(map);
    });

    function fillFilters() {
        const pSel = document.getElementById('pFilter');
        const tSel = document.getElementById('tFilter');
        const ps = [...new Set(data.map(i => i.pluga))].filter(Boolean).sort();
        const ts = [...new Set(data.map(i => i.type))].filter(Boolean).sort();
        ps.forEach(p => pSel.add(new Option(p, p)));
        ts.forEach(t => tSel.add(new Option(t, t)));
    }

    function resetSearch() { document.getElementById('sSearch').value = ""; }

    function filter() {
        const p = document.getElementById('pFilter').value;
        const t = document.getElementById('tFilter').value;
        const s = document.getElementById('sSearch').value.toLowerCase();
        const filtered = data.filter(i => (!p || i.pluga === p) && (!t || i.type === t) && (i.name.toLowerCase().includes(s)));
        
        document.getElementById('destinationsList').innerHTML = data
            .filter(i => (!p || i.pluga === p) && (!t || i.type === t))
            .map(i => `<option value="${i.name}">`).join('');

        updateMarkers(filtered);
    }

    function updateMarkers(list) {
        markersGroup.clearLayers();
        list.forEach(i => {
            const m = L.marker([i.lat, i.lon]).bindPopup(`
                <div style="direction:rtl; text-align:center;">
                    <b>${i.name}</b><br><small>${i.type} | 驻 ${i.pluga}</small>
                    <a href="https://waze.com/ul?ll=${i.lat},${i.lon}&navigate=yes" target="_blank" style="display:block; background:#33ccff; color:white; padding:10px; border-radius:8px; text-decoration:none; margin-top:10px; font-weight:bold;">Waze</a>
                    <button onclick="sendUpdate(${i.id}, '${i.name}')" style="display:block; width:100%; background:#e67e22; color:white; border:none; padding:10px; border-radius:8px; margin-top:8px; font-weight:bold; cursor:pointer;"> 注 拽 砖</button>
                </div>
            `);
            markersGroup.addLayer(m);
        });
        if (list.length > 0) map.fitBounds(list.map(i => [i.lat, i.lon]), {padding: [50,50], maxZoom: 15});
    }

    async function sendUpdate(rowId, name) {
        if (!userMarker) return alert("抓 注  拽");
        if (!confirm(`注 转 ${name}?`)) return;
        const pos = userMarker.getLatLng();
        try {
            fetch(`${scriptUrl}?row=${rowId}&lat=${pos.lat}&lon=${pos.lng}`, { mode: 'no-cors' });
            alert("砖 注!");
            setTimeout(() => location.reload(), 1500);
        } catch (e) { alert("转拽"); }
    }

    initMap();
    loadData();
</script>
</body>
</html>
